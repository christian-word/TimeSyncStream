<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Христианская Музыка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:image" content="https://raw.githubusercontent.com/christian-word/TimeSyncStream/main/ico/liveyoutube.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0E0E10;
      --surface:#18181B;
      --surface-light:#27272A;
      --primary:#9146FF;
      --primary-glow:#9146FF40;
      --text:#EFEFEF;
      --text2:#A0A0A0;
      --radius:12px;
      --font:'Inter',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
    }
    /* Светлая тема */
    body.light{
      --bg:#F0F2F5;
      --surface:#FFFFFF;
      --surface-light:#E5E7EB;
      --primary:#007bff;
      --primary-glow:#007bff40;
      --text:#1F2937;
      --text2:#6B7280;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      padding:24px 16px 60px;
      transition: background 0.5s ease, color 0.5s ease;
    }
    header{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    h1{
      font-size:20px;font-weight:700;
      background: linear-gradient(135deg, var(--primary) 0%, #772CE8 50%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #themeToggleBtn{
      padding:8px 16px;border-radius:8px;
      background:var(--surface);
      border:2px solid var(--primary);color:var(--text);
      font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;
      white-space:nowrap;flex-shrink:0;flex-grow:0;
    }
    #themeToggleBtn:hover{background:var(--surface-light);border-color:#772CE8}

    /* Плеер */
    #player-container{
      width:100%;
      max-width:1200px;
      background:var(--surface);
      border-radius:var(--radius);
      overflow:hidden;
      position:relative;
      box-shadow:0 10px 30px #00000050;
    }
    #player-wrapper{position:relative;width:100%;height:0;padding-bottom:56.25%}
    #player{position:absolute;top:0;left:0;width:100%;height:100%}
    #live-indicator{
      position:absolute;top:12px;left:12px;
      display:none;align-items:center;gap:6px;
      background:#00000060;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;
    }
    #live-indicator span{width:8px;height:8px;background:red;border-radius:50%;animation:pulse 1.2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.6}}

    /* Прогресс-бар */
    #progressBarContainer{height:4px;background:#000;cursor:pointer}
    #progressBar{height:100%;background:var(--primary);width:0;transition:width .1s linear}

    /* Контролы */
    #controls{
      display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:12px 16px;
      background:var(--surface-light);
    }
    
    /* Мобильная адаптация контролов */
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        gap: 8px;
        padding: 10px 12px;
      }
      
      .controls-row {
        display: flex;
        width: 100%;
        gap: 8px;
      }
      
      .controls-row button {
        flex: 1;
        padding: 8px 12px;
        font-size: 13px;
      }
      
      #timezoneSelector {
        width: 100%;
        padding: 8px 12px;
      }
    }
    
    button{
      background:var(--primary);color:#fff;border:none;
      padding:10px 18px;border-radius:var(--radius);
      font-weight:600;cursor:pointer;transition:background .2s;
      flex-grow:1;
    }
    button:hover{background:#772CE8}
    select{
      background:var(--surface);color:var(--text);
      border:1px solid #444;padding:10px 14px;border-radius:var(--radius);
      font-size:14px;cursor:pointer;
      flex-grow:1;
    }
    body.light select{
        border:1px solid #ddd;
    }

    /* Статус + время */
    #status, #localTimeStatus, #realTimeStatus{
      font-size:13px;color:var(--text2);
      margin-top:6px;text-align:center;
    }

    /* Расписание */
    #programScheduleDisplay{
      width:100%;max-width:1200px;margin-top:32px;
    }
    #programScheduleDisplay h2{font-size:18px;margin-bottom:12px}
    #scheduleList{list-style:none;display:grid;gap:10px}
    .schedule-item{
      background:var(--surface);padding:14px 18px;border-radius:var(--radius);
      display:flex;justify-content:space-between;align-items:center;
      border:1px solid transparent;transition:border .2s;
    }
    .schedule-item.current{
      border-color:var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow);
    }
    .schedule-item-left{
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex-grow: 1;
    }
    .schedule-item-right{
        text-align: right;
        flex-shrink: 0;
        margin-left: 10px;
    }
    .schedule-item strong{font-weight:600}
    .schedule-item small{color:var(--text2)}

    /* Полноэкран */
    #exitFullscreenBtn{
      position:absolute;top:12px;right:12px;z-index:9999;
      width:36px;height:36px;border-radius:50%;
      background:#00000060;color:#fff;border:none;font-size:18px;
      cursor:pointer;opacity:0;pointer-events:none;transition:opacity .3s;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    .virtual-fullscreen #exitFullscreenBtn{opacity:0.7;pointer-events:auto}
    .virtual-fullscreen #exitFullscreenBtn:hover{opacity:1;background:#00000090}
    .virtual-fullscreen #player-container{
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%) rotate(90deg);
      width:100vh;height:100vw;max-width:none;z-index:9999;
    }
    .virtual-fullscreen #controls,
    .virtual-fullscreen header,
    .virtual-fullscreen #programScheduleDisplay{display:none}
    
    #fullscreenToggleBtn {
        display: inline-block;
    }
    @media (max-width: 768px) {
        body {
            padding: 16px 12px 60px;
        }
    }
  </style>
</head>
<body>
  <header>
    <h1>Христианская Музыка</h1>
    <button id="themeToggleBtn" title="Сменить тему">Тема</button>
  </header>

  <div id="player-container">
    <div id="player-wrapper">
      <div id="player"></div>
      <button id="exitFullscreenBtn">✕</button>
      <div id="live-indicator"><span></span>LIVE</div>
    </div>
    <div id="progressBarContainer"><div id="progressBar"></div></div>

    <div id="controls">
      <div class="controls-row">
        <button id="playButton">▶ Смотреть</button>
        <button id="fullscreenToggleBtn">⛶ Полный экран</button>
      </div>
      <select id="timezoneSelector">
        <option value="0" selected>⏰ Текущее время</option>
        <option value="3600">⏩ На час вперёд</option>
        <option value="-3600">⏪ На час назад</option>
        <option value="-10800">⏮ На 3 часа назад</option>
      </select>
    </div>
  </div>

  <div id="status">Статус: Загрузка расписания...</div>
  <div id="localTimeStatus">Местное время трансляции: --:--</div>
  <div id="realTimeStatus">Текущее время: --:--</div>

  <div id="programScheduleDisplay">
    <h2>📋 Расписание трансляции</h2>
    <ul id="scheduleList"></ul>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    /* ---------- 1.  Тема ---------- */
    const themeBtn=document.getElementById('themeToggleBtn');
    themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');
    });
    if(localStorage.getItem('theme')==='light') document.body.classList.add('light');

    /* ---------- 2.  YouTube ---------- */
    let player,playButton=document.getElementById('playButton'),
        timezoneSelector=document.getElementById('timezoneSelector'),
        fullscreenToggleBtn=document.getElementById('fullscreenToggleBtn'),
        exitFullscreenBtn=document.getElementById('exitFullscreenBtn'),
        statusDiv=document.getElementById('status'),
        localTimeStatusDiv=document.getElementById('localTimeStatus'),
        realTimeStatusDiv=document.getElementById('realTimeStatus'),
        progressBar=document.getElementById('progressBar'),
        scheduleList=document.getElementById('scheduleList'),
        liveIndicator=document.getElementById('live-indicator');
    let currentVideoIndex=0,syncTimer=null,progressTimer=null;

    function onYouTubeIframeAPIReady(){
      player=new YT.Player('player',{
        height:'100%',width:'100%',
        events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}
      });
    }
    function onPlayerReady(){
      fetchPlaylist();
      playButton.addEventListener('click',startBroadcast);
      timezoneSelector.addEventListener('change',startBroadcast);
    }
    /* ---------- 3.  Плейлист ---------- */
    const PLAYLIST_URL='https://dl.dropboxusercontent.com/scl/fi/xpjfeyn1lmfoqgdw72av1/playMysic.json?rlkey=1wwqrsewvrkwrjxofrvnwtz76&st=pa96sy4u&dl=1';
    let broadcastProgram=null;
    async function fetchPlaylist(){
      try{
        const r=await fetch(PLAYLIST_URL);if(!r.ok) throw new Error('Не удалось загрузить плейлист');
        const data=await r.json();
        let t=0;data.programSchedule.forEach(v=>{v.startTime=t;t+=v.duration;});
        broadcastProgram=data;statusDiv.textContent='Плеер готов. Выберите поправку и нажмите Play.';
        playButton.disabled=false;timezoneSelector.disabled=false;fullscreenToggleBtn.disabled=false;
        renderSchedule();
      }catch(e){statusDiv.textContent='Ошибка: '+e.message;}
    }
    /* ---------- 4.  Трансляция ---------- */
    function startBroadcast(){
      if(!broadcastProgram) return;
      if(syncTimer) clearInterval(syncTimer);
      if(progressTimer) clearInterval(progressTimer);
      statusDiv.textContent='Синхронизируем и запускаем...';
      liveIndicator.style.display='flex';
      const offset=parseInt(timezoneSelector.value,10);
      const real=Date.now()/1000;
      const start=new Date(broadcastProgram.broadcastStartTime).getTime()/1000;
      let elapsed=real-start+offset;
      let vid=null,sec=0,idx=0;
      if(elapsed<0){vid=broadcastProgram.programSchedule[0];sec=0;idx=0;}
      else{
        for(let i=0;i<broadcastProgram.programSchedule.length;i++){
          const v=broadcastProgram.programSchedule[i];
          if(elapsed>=v.startTime&&elapsed<v.startTime+v.duration){vid=v;sec=elapsed-v.startTime;idx=i;break;}
        }
      }
      if(vid){
        player.loadVideoById({videoId:vid.videoId,startSeconds:Math.max(0,sec),suggestedQuality:'large'});
        currentVideoIndex=idx;
      }
      startSyncTimer(start);highlightCurrentVideo(currentVideoIndex);startProgressTimer();
    }
    function onPlayerStateChange(e){
      if(e.data===YT.PlayerState.ENDED){
        currentVideoIndex++;
        if(currentVideoIndex<broadcastProgram.programSchedule.length){
          const v=broadcastProgram.programSchedule[currentVideoIndex];
          player.loadVideoById({videoId:v.videoId,startSeconds:0,suggestedQuality:'large'});
        }else{statusDiv.textContent='Плейлист закончился';liveIndicator.style.display='none';}
      }else if(e.data===YT.PlayerState.PLAYING){liveIndicator.style.display='flex';}
      else{liveIndicator.style.display='none';}
    }
    /* ---------- 5.  Синхронизация ---------- */
    function startSyncTimer(broadcastStartTimeInSeconds){
      syncTimer=setInterval(()=>{
        const now=Date.now()/1000;
        const offset=parseInt(timezoneSelector.value,10);
        const elapsedTime = now - broadcastStartTimeInSeconds + offset;
        
        const display=new Date((broadcastStartTimeInSeconds + elapsedTime) * 1000);
        localTimeStatusDiv.textContent=`Местное время трансляции: ${display.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
        
        let idx=-1,sec=0;
        if(elapsedTime<0){idx=0;sec=0;}
        else{
          for(let i=0;i<broadcastProgram.programSchedule.length;i++){
            const v=broadcastProgram.programSchedule[i];
            if(elapsedTime>=v.startTime&&elapsedTime<v.startTime+v.duration){idx=i;sec=elapsedTime-v.startTime;break;}
          }
        }
        if(idx===-1) return;
        if(idx!==currentVideoIndex){
          currentVideoIndex=idx;
          player.loadVideoById({videoId:broadcastProgram.programSchedule[currentVideoIndex].videoId,startSeconds:Math.max(0,sec),suggestedQuality:'large'});
          statusDiv.textContent=`Смена видео на #${currentVideoIndex+1}`;highlightCurrentVideo(currentVideoIndex);return;
        }
        const drift=player.getCurrentTime()-sec;
        if(Math.abs(drift)>1){player.setPlaybackRate(drift>0?.9:1.1);statusDiv.textContent=`Корректировка скорости. Разница: ${drift.toFixed(2)}с`;}
        else{player.setPlaybackRate(1);statusDiv.textContent='Синхронизировано';}
      },1000);
    }
    function startProgressTimer(){
      if(progressTimer) clearInterval(progressTimer);
      progressTimer=setInterval(()=>{
        if(player&&player.getDuration){
          const cur=player.getCurrentTime(),dur=player.getDuration();
          if(dur>0) progressBar.style.width=(cur/dur*100)+'%';
        }
      },500);
    }
    /* ---------- 6.  Расписание ---------- */
    function parseVideoInfo(title, index) {
      if (!title) {
        return {
          shortTitle: `Видео №${index + 1}`,
          speakerAndDate: ''
        };
      }
      
      const parts = title.split(', ');
      let speakerAndDate = '';
      let shortTitle = '';

      if (parts.length >= 2) {
        const date = parts.pop();
        const speaker = parts.pop();
        speakerAndDate = `${speaker}, ${date}`;
        shortTitle = parts.join(', ');
      } else {
        shortTitle = title;
      }

      if (shortTitle.length > 50) {
        shortTitle = shortTitle.substring(0, 50) + '...';
      }

      return { shortTitle, speakerAndDate };
    }
    
    function renderSchedule(){
      if(!broadcastProgram) return;
      scheduleList.innerHTML='';
      const start=new Date(broadcastProgram.broadcastStartTime).getTime()/1000;
      broadcastProgram.programSchedule.forEach((v,i)=>{
        const li=document.createElement('li');li.className='schedule-item';li.dataset.index=i;
        const videoStartTime = new Date((start + v.startTime) * 1000);
        const videoEndTime = new Date((start + v.startTime + v.duration) * 1000);
        const { shortTitle, speakerAndDate } = parseVideoInfo(v.title, i);

        // Добавляем длительность в секундах и ссылку на YouTube
        const durationMinutes = Math.floor(v.duration / 60);
        const durationSeconds = v.duration % 60;
        const durationFormatted = `${durationMinutes} мин ${durationSeconds} сек`;
        const youtubeUrl = `https://www.youtube.com/watch?v=${v.videoId}`;

        li.innerHTML=`
          <div class="schedule-item-left">
            <strong>
              <a href="${youtubeUrl}" target="_blank" style="color:inherit; text-decoration:none;">
                ${shortTitle}
              </a>
            </strong>
            <small>${speakerAndDate}</small>
            <small>Длительность: ${durationFormatted}</small>
          </div>
          <div class="schedule-item-right">
            <small>
                ${videoStartTime.getHours().toString().padStart(2, '0')}:${videoStartTime.getMinutes().toString().padStart(2, '0')} – 
                ${videoEndTime.getHours().toString().padStart(2, '0')}:${videoEndTime.getMinutes().toString().padStart(2, '0')}
            </small>
          </div>
        `;
        scheduleList.appendChild(li);
      });
    }
    function highlightCurrentVideo(index){
      document.querySelectorAll('.schedule-item').forEach(item=>item.classList.remove('current'));
      const cur=document.querySelector(`.schedule-item[data-index="${index}"]`);
      if(cur) cur.classList.add('current');
    }
    /* ---------- 7.  Полноэкран ---------- */
    function isMobile() {
      return window.innerWidth <= 768;
    }
    
    fullscreenToggleBtn.addEventListener('click',()=>{
      if(isMobile()) {
        // Мобильный: виртуальный полноэкранный режим с поворотом
        document.body.classList.add('virtual-fullscreen');
        setTimeout(()=>player.setSize('100%','100%'),500);
      } else {
        // ПК: настоящий полноэкранный режим
        const container = document.getElementById('player-container');
        if(container.requestFullscreen) {
          container.requestFullscreen();
        } else if(container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if(container.mozRequestFullScreen) {
          container.mozRequestFullScreen();
        } else if(container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      }
    });
    
    exitFullscreenBtn.addEventListener('click',()=>{
      document.body.classList.remove('virtual-fullscreen');
      setTimeout(()=>player.setSize('100%','100%'),500);
    });
    
    // Обработчик выхода из полноэкранного режима для ПК
    document.addEventListener('fullscreenchange', ()=>{
      if(!document.fullscreenElement) {
        player.setSize('100%','100%');
      }
    });
    document.addEventListener('webkitfullscreenchange', ()=>{
      if(!document.webkitFullscreenElement) {
        player.setSize('100%','100%');
      }
    });
    /* ---------- 8.  Часы ---------- */
    setInterval(()=>realTimeStatusDiv.textContent='Текущее время: '+new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),1000);
  </script>
</body>
</html>
